<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Freepbx on ivahaev.ru</title>
    <link>https://ivahaev.ru/tags/freepbx/index.xml</link>
    <description>Recent content in Freepbx on ivahaev.ru</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ru-RU</language>
    <copyright>2016 Евгений Иваха</copyright>
    <atom:link href="https://ivahaev.ru/tags/freepbx/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Проигрывание файла при телефонном разговоре</title>
      <link>https://ivahaev.ru/post/proighryvaniie-faila-pri-tieliefonnom-razghovorie/</link>
      <pubDate>Wed, 11 Nov 2015 01:53:02 +0500</pubDate>
      
      <guid>https://ivahaev.ru/post/proighryvaniie-faila-pri-tieliefonnom-razghovorie/</guid>
      <description>&lt;p&gt;В работе оператора колл-центра часто возникает необходимость проиграть в канал заранее заготовленные голосовые файлы, например, адреса офисов и режимы работы.&lt;/p&gt;

&lt;p&gt;Рассмотрим вариант решения данной задачи на базе &lt;strong&gt;IP PBX Asterisk&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;Пример для &lt;strong&gt;FreePBX&lt;/strong&gt;, для голого астериска все делается ещё проще.&lt;/p&gt;

&lt;p&gt;Первым делом, нужно добавить сочетание клавиш на вызов макроса в &lt;code&gt;features.conf&lt;/code&gt;, или для &lt;strong&gt;FreePBX&lt;/strong&gt; в &lt;code&gt;features_applicationmap_custom.conf&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;playsound =&amp;gt; *6,callee,macro,playsound
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;По нажатию в разговоре *&lt;strong&gt;6&lt;/strong&gt; вызовется макрос playsound&lt;/p&gt;

&lt;p&gt;Важный момент, нужно добавить возможность вызова макроса. Для этого либо в дайлплане присваиваем переменную:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exten =&amp;gt; _+x.,n,Set(DYNAMIC_FEATURES=playsound)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Либо в &lt;strong&gt;extensions.conf&lt;/strong&gt; пишем в секции &lt;strong&gt;[globals]&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;DYNAMIC_FEATURES=playsound
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Макрос и нужный контекст в дайлплане:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[macro-playsound]

exten =&amp;gt; s,1,AGI(create_spy.php,${CHANNEL})

; end of [macro-playsound]

[spy]
exten =&amp;gt; 1,1,Chanspy(${chan},v(-4)wqBbE)
exten =&amp;gt; 1,n,Hangup

exten =&amp;gt; 2,1,Answer
exten =&amp;gt; 2,n,Set(VOLUME(TX)=-3)
exten =&amp;gt; 2,n,Playback(${audio})
exten =&amp;gt; 2,n,Hangup

; end of [spy]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Файл &lt;strong&gt;create_spy.agi&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/usr/bin/php -q

&amp;lt;?php

$par=$argv[1];
$channel= $par;

    $uid=time();
    $f1=fopen(&amp;quot;/tmp/$uid.call&amp;quot;,&amp;quot;w&amp;quot;);
    fputs($f1,&amp;quot;Channel: LOCAL/2@spy\n&amp;quot;);
    fputs($f1,&amp;quot;MaxRetries: 0\n&amp;quot;);
    fputs($f1,&amp;quot;RetryTime: 600\n&amp;quot;);
    fputs($f1,&amp;quot;WaitTime: 30\n&amp;quot;);
    fputs($f1,&amp;quot;Context: spy\n&amp;quot;);
    fputs($f1,&amp;quot;Extension: 1\n&amp;quot;);
    fputs($f1,&amp;quot;Priority: 1\n&amp;quot;);
    fputs($f1,&amp;quot;Set: audio=custom/VOICE_FILE\nSet: chan=$channel\n&amp;quot;);
    fclose($f1);
    system(&amp;quot;mv /tmp/$uid.call /var/spool/asterisk/outgoing/&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Здесь &lt;strong&gt;VOICE_FILE&lt;/strong&gt; - это проигрываемый файл.  Не забыть сделать &lt;code&gt;chmod +x /var/lib/asterisk/agi-bin/create_spy.php&lt;/code&gt; ну или где в нашем дистрибутиве расположены &lt;strong&gt;agi&lt;/strong&gt; скрипты.&lt;/p&gt;

&lt;p&gt;Само собой, можно сделать все через &lt;strong&gt;AMI&lt;/strong&gt;, в данном случае, была задача показать вариант решения вопроса. Реализация за вами!&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>